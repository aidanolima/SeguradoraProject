<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissão de Apólice - Gestor</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' blob: data: gap:; style-src * 'self' 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; object-src * 'self' blob: data: gap:; img-src * 'self' 'unsafe-inline' blob: data: gap:; connect-src 'self' * 'unsafe-inline' blob: data: gap:; frame-src * 'self' blob: data: gap:;">

    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .loading { color: #666; font-style: italic; }
        .btn-processar {
            background-color: #2e7d32; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 10px; display: none; 
        }
        .btn-processar:hover { background-color: #1b5e20; }
        #status-pdf { font-size:14px; margin-top:10px; min-height: 20px; font-weight: bold; }
    </style>
</head>
<body class="dashboard-body">

    <header class="app-header">
        <div class="header-brand">
            <a href="dashboard.html">
                <img src="assets/logo.png" alt="Logo" class="header-logo">
            </a>
        </div>

        <nav class="header-nav">
            <a href="dashboard.html" class="header-link">PROPOSTAS</a>
            <a href="apolice.html" class="header-link active">APÓLICES</a>
            <a href="registro.html?origin=dashboard" class="header-link">USUÁRIOS</a>
            <a href="relatorios.html" class="header-link">RELATÓRIOS</a>
        </nav>

        <div class="header-user-area">
            <div class="user-info">
                <span class="user-name">Olá, <strong id="user-name-display">...</strong></span>
                <span class="user-role" id="user-role-display">...</span>
            </div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        
        <div style="margin-bottom: 20px; border-left: 5px solid #2e7d32; padding-left: 15px;">
            <h2 id="titulo-pagina" style="color: #444; margin:0;">Emissão de Apólice</h2>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Preencha os dados manualmente ou importe um PDF.</p>
        </div>

        <div class="card" style="border-top: 4px solid #1976d2;">
            <div style="text-align: center;">
                <h3 style="margin:0 0 10px 0; color:#1976d2;"><i class="fas fa-file-pdf"></i> 1. Importar PDF (Opcional)</h3>
                <p style="font-size:13px; color:#555;">Selecione o PDF da apólice para preencher os dados automaticamente.</p>
                
                <input type="file" id="pdf_upload" name="arquivo_pdf" accept=".pdf" style="margin-top:10px;">
                <br>
                <button type="button" id="btn-ler-pdf" class="btn-processar">⚡ Processar Dados do PDF</button>
                <p id="status-pdf"></p>
            </div>
        </div>

        <div class="card" id="painel-apolice">
            <h3 style="margin:0 0 20px 0; color:#2e7d32; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <i class="fas fa-pen-nib"></i> 2. Dados da Apólice
            </h3>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Dados do Vínculo</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="veiculo_id">Selecione o Cliente / Veículo *</label>
                        <select id="veiculo_id" class="campo-obrigatorio" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Carregando clientes...</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Detalhes do Contrato</legend>
                <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="numero_apolice">Nº da Apólice</label>
                        <input type="text" id="numero_apolice" class="campo-dado" placeholder="Ex: 005.123.456" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="numero_proposta">Nº da Proposta (Cia)</label>
                        <input type="text" id="numero_proposta" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="vigencia_inicio">Início Vigência</label>
                        <input type="date" id="vigencia_inicio" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="vigencia_fim">Fim Vigência</label>
                        <input type="date" id="vigencia_fim" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Valores Financeiros</legend>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="premio_liquido">Prêmio Líquido (R$)</label>
                        <input type="number" id="premio_liquido" class="campo-dado" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="premio_total">Prêmio Total (R$)</label>
                        <input type="number" id="premio_total" class="campo-dado" step="0.01" style="width: 100%; padding: 10px; background:#e8f5e9; border:1px solid #2e7d32; border-radius: 4px; font-weight: bold;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="franquia_casco">Franquia (R$)</label>
                        <input type="number" id="franquia_casco" class="campo-dado" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </fieldset>

            <button type="button" id="btn-acao-salvar" class="btn-novo" style="width:100%; margin-top:10px; padding: 15px; background-color: #2e7d32; color: white; font-weight: bold; border: none; cursor: pointer; border-radius: 4px; font-size: 16px;">
                <i class="fas fa-save"></i> SALVAR APÓLICE
            </button>
        </div>

        <div class="system-credits" style="text-align: center;">
            By Áidano Lima - ASL TECH
        </div>
    </div>

    <script>
        const API_URL = 'https://api-seguradora.onrender.com';
        const urlParams = new URLSearchParams(window.location.search);
        const idEdicao = urlParams.get('id');
        const token = localStorage.getItem('token');
        
        console.log("Sistema v3.0 Iniciado");

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Atualizar Nome do Usuário (Script do Cabeçalho)
            const nome = localStorage.getItem('usuario_logado');
            const tipo = localStorage.getItem('tipo_usuario');
            if (nome) document.getElementById('user-name-display').innerText = nome.split(' ')[0];
            if (tipo) document.getElementById('user-role-display').innerText = tipo.toUpperCase();
            
            // Botão Sair
            document.getElementById('btn-logout').addEventListener('click', function() {
                localStorage.clear();
                window.location.href = 'index.html';
            });

            // 2. Lógica da Página
            if (!token) { window.location.href = 'index.html'; return; }
            
            carregarVeiculos();

            if (idEdicao) {
                document.getElementById('titulo-pagina').innerText = `Editando Apólice #${idEdicao}`;
                document.getElementById('btn-acao-salvar').innerHTML = '<i class="fas fa-sync-alt"></i> ATUALIZAR DADOS';
                document.getElementById('pdf_upload').disabled = true; 
                carregarDadosParaEdicao(idEdicao);
            }

            // Listeners
            document.getElementById('pdf_upload').addEventListener('change', function() {
                const btn = document.getElementById('btn-ler-pdf');
                if (this.files.length > 0) btn.style.display = 'inline-block';
                else btn.style.display = 'none';
            });

            document.getElementById('btn-ler-pdf').addEventListener('click', processarPDF);
            document.getElementById('btn-acao-salvar').addEventListener('click', executarSalvamento);
        });

        // ======================================================
        // FUNÇÃO DE SALVAR BLINDADA
        // ======================================================
        async function executarSalvamento(e) {
            if(e) e.preventDefault();
            console.log("Iniciando salvamento...");

            const veiculo = document.getElementById('veiculo_id').value;
            if (!veiculo || veiculo === "") {
                Swal.fire('Atenção', 'Selecione um Cliente/Veículo obrigatoriamente.', 'warning');
                return;
            }

            const endpoint = idEdicao ? `${API_URL}/apolices/${idEdicao}` : `${API_URL}/cadastrar-apolice`;
            const method = idEdicao ? 'PUT' : 'POST';
            let body;
            let headers = { 'Authorization': `Bearer ${token}` };

            if (idEdicao) {
                headers['Content-Type'] = 'application/json';
                body = JSON.stringify(capturarDadosJSON());
            } else {
                body = new FormData();
                const dados = capturarDadosJSON();
                for (const key in dados) {
                    body.append(key, dados[key]);
                }
                const fileInput = document.getElementById('pdf_upload');
                if (fileInput.files.length > 0) body.append('arquivo_pdf', fileInput.files[0]);
            }

            try {
                Swal.fire({
                    title: 'Salvando...',
                    text: 'Não feche a página.',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    didOpen: () => { Swal.showLoading() }
                });

                const res = await fetch(endpoint, { method, headers, body });

                if (res.ok) {
                    const msg = idEdicao ? "Atualizado com sucesso!" : "Cadastrado com sucesso!";
                    
                    await Swal.fire({
                        icon: 'success',
                        title: 'Sucesso!',
                        text: msg,
                        confirmButtonColor: '#2e7d32',
                        confirmButtonText: 'OK (Ir para Painel)',
                        allowOutsideClick: false
                    });
                    
                    window.location.href = 'dashboard.html';

                } else {
                    const err = await res.json();
                    Swal.fire('Erro', err.message || 'Erro desconhecido', 'error');
                }
            } catch (error) { 
                console.error(error);
                Swal.fire('Erro de Conexão', 'O servidor pode estar offline.', 'error');
            }
        }

        function capturarDadosJSON() {
            return {
                veiculo_id: document.getElementById('veiculo_id').value,
                numero_apolice: document.getElementById('numero_apolice').value,
                numero_proposta: document.getElementById('numero_proposta').value,
                vigencia_inicio: document.getElementById('vigencia_inicio').value,
                vigencia_fim: document.getElementById('vigencia_fim').value,
                premio_liquido: document.getElementById('premio_liquido').value,
                premio_total: document.getElementById('premio_total').value,
                franquia_casco: document.getElementById('franquia_casco').value
            };
        }

        async function processarPDF() {
            const fileInput = document.getElementById('pdf_upload');
            const statusMsg = document.getElementById('status-pdf');
            if (fileInput.files.length === 0) return;

            statusMsg.innerText = "Lendo arquivo...";
            const formData = new FormData();
            formData.append('pdf', fileInput.files[0]);

            try {
                const response = await fetch(`${API_URL}/importar-pdf`, { method: 'POST', body: formData });
                if (response.ok) {
                    const dados = await response.json();
                    statusMsg.innerText = "Dados extraídos!";
                    preencherFormularioComPDF(dados);
                    Swal.fire({ icon: 'info', title: 'PDF Lido', text: 'Dados preenchidos.', timer: 1500, showConfirmButton: false });
                } else {
                    statusMsg.innerText = "Erro PDF.";
                    Swal.fire('Erro', 'Falha ao ler PDF', 'error');
                }
            } catch (error) { statusMsg.innerText = "Erro conexão PDF."; }
        }

        function preencherFormularioComPDF(dados) {
            if (dados.placa) {
                const select = document.getElementById('veiculo_id');
                const placaLimpa = dados.placa.replace('-', '').toUpperCase();
                let encontrou = false;
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].text.toUpperCase().replace('-', '').includes(placaLimpa)) {
                        select.selectedIndex = i;
                        encontrou = true;
                        break;
                    }
                }
                if(!encontrou) Swal.fire('Atenção', `Placa ${dados.placa} não encontrada.`, 'warning');
            }
            if (dados.datas && dados.datas.length >= 2) {
                document.getElementById('vigencia_inicio').value = formatData(dados.datas[0]);
                document.getElementById('vigencia_fim').value = formatData(dados.datas[1]);
            }
            if (dados.valores && dados.valores.length > 0) {
                const val1 = limparMoeda(dados.valores[0]); 
                document.getElementById('premio_total').value = val1;
                if(dados.valores.length > 1) {
                    const val2 = limparMoeda(dados.valores[1]);
                    if(parseFloat(val2) > parseFloat(val1)) {
                         document.getElementById('premio_total').value = val2;
                         document.getElementById('premio_liquido').value = val1;
                    } else {
                         document.getElementById('premio_liquido').value = val2;
                    }
                }
            }
        }

        function formatData(d) {
            if(!d) return ''; const p = d.split('/'); return p.length === 3 ? `${p[2]}-${p[1]}-${p[0]}` : '';
        }
        function limparMoeda(v) {
            if(!v) return ''; return v.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
        }

        async function carregarVeiculos() {
            const select = document.getElementById('veiculo_id');
            try {
                const res = await fetch(`${API_URL}/propostas`, { headers: { 'Authorization': `Bearer ${token}` } });
                const propostas = await res.json();
                select.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
                propostas.forEach(p => {
                    const o = document.createElement('option');
                    o.value = p.id; o.text = `${p.nome} | ${p.placa}`;
                    select.appendChild(o);
                });
            } catch (error) { console.error(error); }
        }

        async function carregarDadosParaEdicao(id) {
            try {
                const res = await fetch(`${API_URL}/apolices/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error("Erro");
                const dados = await res.json();
                document.getElementById('veiculo_id').value = dados.veiculo_id;
                document.getElementById('numero_apolice').value = dados.numero_apolice;
                document.getElementById('numero_proposta').value = dados.numero_proposta;
                document.getElementById('premio_liquido').value = dados.premio_liquido;
                document.getElementById('premio_total').value = dados.premio_total;
                document.getElementById('franquia_casco').value = dados.franquia_casco;
                if (dados.vigencia_inicio) document.getElementById('vigencia_inicio').value = dados.vigencia_inicio.split('T')[0];
                if (dados.vigencia_fim) document.getElementById('vigencia_fim').value = dados.vigencia_fim.split('T')[0];
            } catch (error) { Swal.fire('Erro', 'Falha dados.', 'error'); }
        }
    </script>
    <script src="js/auth.js"></script>
</body>
</html>