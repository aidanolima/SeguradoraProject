<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissão de Apólice - Gestor</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' blob: data: gap:; style-src * 'self' 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; object-src * 'self' blob: data: gap:; img-src * 'self' 'unsafe-inline' blob: data: gap:; connect-src 'self' * 'unsafe-inline' blob: data: gap:;">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .loading { color: #666; font-style: italic; }
        .btn-processar { background-color: #2e7d32; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 10px; display: none; }
        .btn-processar:hover { background-color: #1b5e20; }
        #status-pdf { font-size:14px; margin-top:10px; min-height: 20px; font-weight: bold; }
    </style>
</head>
<body class="dashboard-body">

    <header class="app-header">
        <div class="header-brand"><a href="dashboard.html"><img src="assets/logo.png" alt="Logo" class="header-logo"></a></div>
        <nav class="header-nav">
            <a href="dashboard.html" class="header-link">DASHBOARD</a>
            <a href="apolice.html" class="header-link active">APÓLICES</a>
            <a href="registro.html?origin=dashboard" class="header-link">USUÁRIOS</a>
            <a href="relatorios.html" class="header-link">RELATÓRIOS</a>
        </nav>
        <div class="header-user-area">
            <div class="user-info">
                <span class="user-name">Olá, <strong id="user-name-display">...</strong></span>
                <span class="user-role" id="user-role-display">...</span>
            </div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        <div style="margin-bottom: 20px; border-left: 5px solid #2e7d32; padding-left: 15px;">
            <h2 id="titulo-pagina" style="color: #444; margin:0;">Emissão de Apólice</h2>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Preencha os dados manualmente ou importe um PDF.</p>
        </div>

        <div class="card" style="border-top: 4px solid #1976d2;">
            <div style="text-align: center;">
                <h3 style="margin:0 0 10px 0; color:#1976d2;"><i class="fas fa-file-pdf"></i> 1. Importar PDF (Opcional)</h3>
                <p style="font-size:13px; color:#555;">Selecione o PDF da apólice para preencher os dados automaticamente.</p>
                
                <input type="file" id="pdf_upload" name="arquivo_pdf" accept="application/pdf" style="margin-top:10px;">
                <br>
                <button type="button" id="btn-ler-pdf" class="btn-processar">⚡ Processar Dados do PDF</button>
                <p id="status-pdf"></p>
            </div>
        </div>

        <div class="card" id="painel-apolice">
            <h3 style="margin:0 0 20px 0; color:#2e7d32; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <i class="fas fa-pen-nib"></i> 2. Dados da Apólice
            </h3>
            
            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Dados do Vínculo</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="veiculo_id">Selecione o Cliente / Veículo *</label>
                        <select id="veiculo_id" class="campo-obrigatorio" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Carregando clientes...</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Detalhes do Contrato</legend>
                <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="numero_apolice">Nº da Apólice</label>
                        <input type="text" id="numero_apolice" class="campo-dado" placeholder="Ex: 005.123.456" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="numero_proposta">Nº da Proposta (Cia)</label>
                        <input type="text" id="numero_proposta" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="vigencia_inicio">Início Vigência</label>
                        <input type="date" id="vigencia_inicio" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="vigencia_fim">Fim Vigência</label>
                        <input type="date" id="vigencia_fim" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Valores Financeiros</legend>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="premio_liquido">Prêmio Líquido (R$)</label>
                        <input type="number" id="premio_liquido" class="campo-dado" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="premio_total">Prêmio Total (R$)</label>
                        <input type="number" id="premio_total" class="campo-dado" step="0.01" style="width: 100%; padding: 10px; background:#e8f5e9; border:1px solid #2e7d32; border-radius: 4px; font-weight: bold;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="franquia_casco">Franquia (R$)</label>
                        <input type="number" id="franquia_casco" class="campo-dado" step="0.01" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </fieldset>

            <button type="button" id="btn-acao-salvar" class="btn-novo" style="width:100%; margin-top:10px; padding: 15px; background-color: #2e7d32; color: white; font-weight: bold; border: none; cursor: pointer; border-radius: 4px; font-size: 16px;">
                <i class="fas fa-save"></i> SALVAR APÓLICE
            </button>
        </div>
        <div class="system-credits" style="text-align: center;">By Áidano Lima - ASL TECH</div>
    </div>
<script>
        (function() {
            const LOCAL_API_URL = 'http://localhost:3000';
            const localToken = localStorage.getItem('token');
            const urlParams = new URLSearchParams(window.location.search);
            const idEdicao = urlParams.get('id');

            // --- INICIALIZAÇÃO ---
            document.addEventListener('DOMContentLoaded', () => {
                if (!localToken) { window.location.href = 'index.html'; return; }
                
                // Configuração Visual (Header)
                const nome = localStorage.getItem('usuario_logado');
                const tipo = localStorage.getItem('tipo_usuario');
                if (document.getElementById('user-name-display') && nome) 
                    document.getElementById('user-name-display').innerText = nome.split(' ')[0];
                if (document.getElementById('user-role-display') && tipo) 
                    document.getElementById('user-role-display').innerText = tipo.toUpperCase();

                // Botões
                document.getElementById('btn-logout')?.addEventListener('click', () => { 
                    localStorage.clear(); window.location.href = 'index.html'; 
                });

                const btnLer = document.getElementById('btn-ler-pdf');
                if (btnLer) {
                    btnLer.addEventListener('click', (e) => {
                        e.preventDefault(); 
                        processarPDF();
                    });
                }

                const pdfInput = document.getElementById('pdf_upload');
                if(pdfInput) {
                    pdfInput.addEventListener('change', () => {
                        const btn = document.getElementById('btn-ler-pdf');
                        btn.style.display = (pdfInput.files.length > 0) ? 'inline-block' : 'none';
                    });
                }

                const btnSalvar = document.getElementById('btn-acao-salvar');
                if(btnSalvar) btnSalvar.addEventListener('click', executarSalvamento);

                // Carregamento Inicial
                carregarVeiculos().then(() => {
                    if (idEdicao) prepararModoEdicao();
                });
            });

            // --- FUNÇÃO DE PREENCHIMENTO SEGURA ---
            function setValor(id, valor) {
                const el = document.getElementById(id);
                if (!el) {
                    console.error(`❌ ERRO: Campo '${id}' não encontrado no HTML.`);
                    return;
                }
                if (!valor) return;

                console.log(`⚡ Tentando preencher '${id}' com:`, valor);
                
                // Estratégia Tripla para forçar o valor
                try {
                    // 1. Atribuição Padrão
                    el.value = valor;
                    
                    // 2. Se falhar (campo numérico vazio), tenta remover caracteres estranhos
                    if (el.value === '') {
                        console.warn(`⚠️ Atribuição direta falhou para '${id}'. Tentando limpar...`);
                        // Mantém apenas numeros e ponto
                        const valorLimpo = valor.toString().replace(/[^0-9.]/g, '');
                        el.value = valorLimpo;
                    }
                } catch (e) {
                    console.error(`❌ Falha ao definir valor em '${id}':`, e);
                }
            }

            // --- PROCESSAMENTO DO PDF ---
            async function processarPDF() {
                const fileInput = document.getElementById('pdf_upload');
                const statusMsg = document.getElementById('status-pdf');

                if (!fileInput.files.length) {
                    Swal.fire('Atenção', 'Selecione o arquivo.', 'warning');
                    return;
                }

                statusMsg.innerText = "Processando...";
                statusMsg.style.color = "orange";

                const formData = new FormData();
                formData.append('arquivoPdf', fileInput.files[0]);

                try {
                    const res = await fetch(`${LOCAL_API_URL}/importar-pdf`, { method: 'POST', body: formData });
                    if (!res.ok) throw new Error("Erro de comunicação.");
                    
                    const json = await res.json();
                    const d = json.dados;
                    
                    console.log(">> RECEBIDO DO BACKEND:", d);

                    // --- PREENCHIMENTO FORÇADO ---
                    setValor('numero_apolice', d.numero_apolice);
                    setValor('numero_proposta', d.numero_proposta);
                    setValor('vigencia_inicio', d.vigencia_inicio);
                    setValor('vigencia_fim', d.vigencia_fim);
                    
                    // Atenção especial aos valores monetários
                    setValor('premio_total', d.premio_total);
                    setValor('premio_liquido', d.premio_liquido);
                    setValor('franquia_casco', d.franquia_casco);

                    // --- PLACA ---
                    let msgPlaca = '';
                    if (d.placa) {
                        const sel = document.getElementById('veiculo_id');
                        let achou = false;
                        const busca = d.placa.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        
                        for (let i = 0; i < sel.options.length; i++) {
                            const txt = sel.options[i].text.toUpperCase().replace(/[^A-Z0-9]/g, '');
                            if (txt.includes(busca)) {
                                sel.selectedIndex = i;
                                achou = true;
                                break;
                            }
                        }
                        if (!achou) msgPlaca = `<br><span style="color:red; font-size:12px">(Placa ${d.placa} não cadastrada)</span>`;
                    }

                    statusMsg.innerText = "Preenchido!";
                    statusMsg.style.color = "green";

                    // Alerta Informativo
                    await Swal.fire({
                        icon: 'success',
                        title: 'PDF Processado',
                        html: `<b>Apólice:</b> ${d.numero_apolice || '...'}<br>
                               <b>Total:</b> R$ ${d.premio_total || '...'}<br>
                               <b>Franquia:</b> R$ ${d.franquia_casco || '...'}<br>
                               ${msgPlaca}`,
                        confirmButtonText: 'Conferir'
                    });

                } catch (err) {
                    console.error(err);
                    statusMsg.innerText = "Erro.";
                    Swal.fire('Erro', 'Falha ao processar PDF.', 'error');
                }
            }

            // --- SALVAR ---
            async function executarSalvamento(e) {
                if(e) e.preventDefault();
                const veiculo = document.getElementById('veiculo_id').value;
                if (!veiculo) { Swal.fire('Erro', 'Selecione o Veículo.', 'warning'); return; }

                const endpoint = idEdicao ? `${LOCAL_API_URL}/apolices/${idEdicao}` : `${LOCAL_API_URL}/cadastrar-apolice`;
                const method = idEdicao ? 'PUT' : 'POST';
                let headers = { 'Authorization': `Bearer ${localToken}` };
                
                const formObj = {
                    veiculo_id: veiculo,
                    numero_apolice: document.getElementById('numero_apolice').value,
                    numero_proposta: document.getElementById('numero_proposta').value,
                    vigencia_inicio: document.getElementById('vigencia_inicio').value,
                    vigencia_fim: document.getElementById('vigencia_fim').value,
                    premio_liquido: document.getElementById('premio_liquido').value,
                    premio_total: document.getElementById('premio_total').value,
                    franquia_casco: document.getElementById('franquia_casco').value
                };

                let body;
                if (idEdicao) {
                    headers['Content-Type'] = 'application/json';
                    body = JSON.stringify(formObj);
                } else {
                    body = new FormData();
                    for (const k in formObj) body.append(k, formObj[k]);
                    const fileInput = document.getElementById('pdf_upload');
                    if (fileInput.files.length > 0) body.append('arquivo_pdf', fileInput.files[0]);
                }

                try {
                    Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
                    const res = await fetch(endpoint, { method, headers, body });
                    if (res.ok) {
                        await Swal.fire('Sucesso!', 'Salvo com sucesso.', 'success');
                        window.location.href = 'dashboard.html';
                    } else {
                        const err = await res.json();
                        Swal.fire('Erro', err.message || 'Erro ao salvar.', 'error');
                    }
                } catch (err) { Swal.fire('Erro', 'Falha na conexão.', 'error'); }
            }

            // Funções de Carregamento (Veículos e Edição)
            async function carregarVeiculos() {
                try {
                    const res = await fetch(`${LOCAL_API_URL}/propostas`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                    const lista = await res.json();
                    const sel = document.getElementById('veiculo_id');
                    sel.innerHTML = '<option value="">-- Selecione --</option>';
                    lista.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = `${p.nome} | ${p.placa}`;
                        sel.appendChild(opt);
                    });
                } catch (e) { console.error(e); }
            }

            async function prepararModoEdicao() {
                try {
                    const elTitulo = document.getElementById('titulo-pagina');
                    if(elTitulo) elTitulo.innerText = `Editando Apólice #${idEdicao}`;
                    const elBtn = document.getElementById('btn-acao-salvar');
                    if(elBtn) elBtn.innerHTML = 'ATUALIZAR DADOS';
                    const elPdf = document.getElementById('pdf_upload');
                    if(elPdf) elPdf.disabled = true;

                    const res = await fetch(`${LOCAL_API_URL}/apolices/${idEdicao}`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                    if (!res.ok) throw new Error("Erro buscar dados");
                    const d = await res.json();

                    setValor('veiculo_id', d.veiculo_id);
                    setValor('numero_apolice', d.numero_apolice);
                    setValor('numero_proposta', d.numero_proposta);
                    setValor('premio_liquido', d.premio_liquido);
                    setValor('premio_total', d.premio_total);
                    setValor('franquia_casco', d.franquia_casco);
                    
                    if (d.vigencia_inicio) setValor('vigencia_inicio', d.vigencia_inicio.split('T')[0]);
                    if (d.vigencia_fim) setValor('vigencia_fim', d.vigencia_fim.split('T')[0]);

                } catch (e) { console.error(e); }
            }
        })();
    </script>
    

</body>
</html>