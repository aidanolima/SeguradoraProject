<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emiss√£o de Ap√≥lice - Gestor</title>
    
    <script src="js/config.js"></script>

    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' blob: data: gap:; style-src * 'self' 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; connect-src * 'unsafe-inline' blob: data: gap:;">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .loading { color: #666; font-style: italic; }
        .btn-processar { background-color: #2e7d32; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; margin-top: 10px; display: none; }
        .btn-processar:hover { background-color: #1b5e20; }
        #status-pdf { font-size:14px; margin-top:10px; min-height: 20px; font-weight: bold; }

        /* Estilo do Container de Upload */
        .upload-container {
            background-color: #f8f9fa;
            border: 2px dashed #1976d2;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #pdf_upload {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            margin: 10px auto !important;
            max-width: 100%;
        }
    </style>
</head>
<body class="dashboard-body">

    <header class="app-header">
        <div class="header-brand"><a href="dashboard.html"><img src="assets/logo.png" alt="Logo" class="header-logo"></a></div>
        <nav class="header-nav">
            <a href="dashboard.html" class="header-link">DASHBOARD</a>
            <a href="apolice.html" class="header-link active">AP√ìLICES</a>
            <a href="registro.html?origin=dashboard" class="header-link">USU√ÅRIOS</a>
            <a href="relatorios.html" class="header-link">RELAT√ìRIOS</a>
        </nav>
        <div class="header-user-area">
            <div class="user-info">
                <span class="user-name">Ol√°, <strong id="user-name-display">...</strong></span>
                <span class="user-role" id="user-role-display">...</span>
            </div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        <div style="margin-bottom: 20px; border-left: 5px solid #2e7d32; padding-left: 15px;">
            <h2 id="titulo-pagina" style="color: #444; margin:0;">Emiss√£o de Ap√≥lice</h2>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Preencha os dados manualmente ou importe um PDF.</p>
        </div>

        <div class="upload-container">
            <p style="font-size:14px; color:#555; margin-bottom:10px;">
                Selecione o PDF da ap√≥lice para preencher os dados automaticamente.
            </p>
            <input type="file" id="pdf_upload" name="arquivo_pdf" accept="application/pdf">
            
            <button type="button" id="btn-ler-pdf" class="btn-processar">
                <i class="fas fa-bolt"></i> Processar Dados do PDF
            </button>
            <p id="status-pdf"></p>
        </div>

        <div class="card" id="painel-apolice">
            <h3 style="margin:0 0 20px 0; color:#2e7d32; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <i class="fas fa-pen-nib"></i> 2. Dados da Ap√≥lice
            </h3>
            
            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Dados do V√≠nculo</legend>
                <div class="form-row">
                    <div class="form-group">
                        <label for="veiculo_id">Selecione o Cliente / Ve√≠culo *</label>
                        <select id="veiculo_id" class="campo-obrigatorio" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="">Carregando clientes...</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Detalhes do Contrato</legend>
                <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="numero_apolice">N¬∫ da Ap√≥lice</label>
                        <input type="text" id="numero_apolice" class="campo-dado" placeholder="Ex: 005.123.456" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="numero_proposta">N¬∫ da Proposta (Cia)</label>
                        <input type="text" id="numero_proposta" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="vigencia_inicio">In√≠cio Vig√™ncia</label>
                        <input type="date" id="vigencia_inicio" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="vigencia_fim">Fim Vig√™ncia</label>
                        <input type="date" id="vigencia_fim" class="campo-dado" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </fieldset>

            <fieldset style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <legend style="font-weight: bold; color: #555; padding: 0 5px;">Valores Financeiros</legend>
                <div class="form-row" style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="premio_liquido">Pr√™mio L√≠quido (R$)</label>
                        <input type="text" id="premio_liquido" class="campo-dado" placeholder="0,00" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="premio_total">Pr√™mio Total (R$)</label>
                        <input type="text" id="premio_total" class="campo-dado" placeholder="0,00" style="width: 100%; padding: 10px; background:#e8f5e9; border:1px solid #2e7d32; border-radius: 4px; font-weight: bold;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="franquia_casco">Franquia (R$)</label>
                        <input type="text" id="franquia_casco" class="campo-dado" placeholder="0,00" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
            </fieldset>

            <button type="button" id="btn-acao-salvar" class="btn-novo" style="width:100%; margin-top:10px; padding: 15px; background-color: #2e7d32; color: white; font-weight: bold; border: none; cursor: pointer; border-radius: 4px; font-size: 16px;">
                <i class="fas fa-save"></i> SALVAR AP√ìLICE
            </button>
        </div>
        <div class="system-credits" style="text-align: center;">By √Åidano Lima - ASL TECH</div>
    </div>

    <script>
    (function() {
        const BASE_URL = (typeof API_URL !== 'undefined') ? API_URL : 'http://localhost:3000';
        const localToken = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const idEdicao = urlParams.get('id');

        document.addEventListener('DOMContentLoaded', () => {
            console.log("üöÄ Sistema Iniciado.");
            if (!localToken) { window.location.href = 'index.html'; return; }
            
            const nome = localStorage.getItem('usuario_logado');
            if (document.getElementById('user-name-display') && nome) 
                document.getElementById('user-name-display').innerText = nome.split(' ')[0];

            document.getElementById('btn-logout')?.addEventListener('click', () => { 
                localStorage.clear(); window.location.href = 'index.html'; 
            });

            // Upload PDF
            const pdfInput = document.getElementById('pdf_upload');
            const btnLer = document.getElementById('btn-ler-pdf');
            
            if(pdfInput && btnLer) {
                pdfInput.addEventListener('change', () => {
                    if(pdfInput.files.length > 0) {
                        btnLer.style.display = 'inline-block';
                        document.getElementById('status-pdf').innerText = ""; 
                    }
                });
                btnLer.addEventListener('click', (e) => { e.preventDefault(); processarPDF(); });
            }

            const btnSalvar = document.getElementById('btn-acao-salvar');
            if(btnSalvar) btnSalvar.addEventListener('click', executarSalvamento);

            carregarVeiculos().then(() => { if (idEdicao) prepararModoEdicao(); });
        });

        // ============================================================
        // üîß 1. SETTERS ESPEC√çFICOS (SEM AMBIGUIDADE)
        // ============================================================

        // Apenas para TEXTO (Placa, Ap√≥lice, Datas)
        function setValorTexto(id, valor) {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = (valor || '').toString();
        }

        // Apenas para MOEDA (Converte 1000.00 -> 1.000,00)
        function setValorMoeda(id, valor) {
            const el = document.getElementById(id);
            if (!el) return;
            
            if (!valor && valor !== 0) {
                el.value = '';
                return;
            }

            // Limpa qualquer lixo, garante float
            let str = valor.toString().replace('R$', '').trim();
            let num = parseFloat(str);

            if (isNaN(num)) {
                el.value = ''; // Falhou, limpa
            } else {
                // Formata√ß√£o Brasileira
                el.value = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            console.log(`üí∞ Setando [${id}] orig(${valor}) -> tela(${el.value})`);
        }

        // ============================================================
        // üîß 2. GETTER PARA SALVAR (Converte 1.000,00 -> 1000.00)
        // ============================================================
        function getValorMoeda(id) {
            const el = document.getElementById(id);
            if (!el || !el.value) return '0.00';
            
            let val = el.value;
            // Se tiver v√≠rgula, √© BR. Remove ponto milhar, troca v√≠rgula por ponto.
            if(val.includes(',')) {
                val = val.replace(/\./g, ''); // Remove milhar
                val = val.replace(',', '.');  // Decimal
            }
            return val;
        }

        // ============================================================
        // üìÑ PROCESSAR PDF
        // ============================================================
        async function processarPDF() {
            const fileInput = document.getElementById('pdf_upload');
            const statusMsg = document.getElementById('status-pdf');

            if (!fileInput.files.length) {
                Swal.fire('Aten√ß√£o', 'Selecione um arquivo.', 'warning');
                return;
            }

            statusMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            statusMsg.style.color = "orange";

            const formData = new FormData();
            formData.append('arquivoPdf', fileInput.files[0]);

            try {
                const res = await fetch(`${BASE_URL}/importar-pdf`, { 
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${localToken}` },
                    body: formData 
                });
                
                if (!res.ok) throw new Error("Erro de comunica√ß√£o.");
                
                const json = await res.json();
                const d = json.dados;
                
                console.log("üì¶ DADOS DO PDF:", d);

                // --- PREENCHIMENTO EXPL√çCITO ---
                setValorTexto('numero_apolice', d.numero_apolice);
                setValorTexto('numero_proposta', d.numero_proposta);
                setValorTexto('vigencia_inicio', d.vigencia_inicio);
                setValorTexto('vigencia_fim', d.vigencia_fim);
                
                // Use a fun√ß√£o de MOEDA
                setValorMoeda('premio_total', d.premio_total);
                setValorMoeda('premio_liquido', d.premio_liquido);
                setValorMoeda('franquia_casco', d.franquia_casco);

                statusMsg.innerHTML = `<i class="fas fa-check-circle"></i> <b>${fileInput.files[0].name}</b> lido!`;
                statusMsg.style.color = "green";
                
                // L√≥gica da Placa
                let msgPlaca = '';
                if (d.placa) {
                    const sel = document.getElementById('veiculo_id');
                    let achou = false;
                    const busca = d.placa.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    
                    for (let i = 0; i < sel.options.length; i++) {
                        const txt = sel.options[i].text.toUpperCase().replace(/[^A-Z0-9]/g, '');
                        if (txt.includes(busca)) {
                            sel.selectedIndex = i;
                            achou = true;
                            break;
                        }
                    }
                    msgPlaca = achou ? `<br>‚úÖ Ve√≠culo Identificado` : `<br>‚ùå Placa ${d.placa} n√£o cadastrada`;
                }

                await Swal.fire({
                    icon: 'success',
                    title: 'Dados Carregados!',
                    html: `Total: <b>${document.getElementById('premio_total').value}</b><br>${msgPlaca}`,
                    timer: 2000
                });

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "Erro ao processar.";
                Swal.fire('Erro', 'Falha ao ler PDF.', 'error');
            }
        }

        // ============================================================
        // üíæ SALVAR AP√ìLICE (COM ARQUIVO)
        // ============================================================
        async function ejecutarSalvamento(e) {
            if(e) e.preventDefault();
            const veiculo = document.getElementById('veiculo_id').value;
            if (!veiculo) { Swal.fire('Erro', 'Selecione o Ve√≠culo.', 'warning'); return; }

            // Endpoint
            const endpoint = idEdicao ? `${BASE_URL}/apolices/${idEdicao}` : `${BASE_URL}/cadastrar-apolice`;
            const method = idEdicao ? 'PUT' : 'POST';
            
            // Verifica arquivo
            const fileInput = document.getElementById('pdf_upload');
            // Se for NOVO REGISTRO e tiver arquivo, OU se for EDI√á√ÉO e tiver arquivo novo
            const temArquivo = fileInput && fileInput.files.length > 0;

            // 1. Cria FormData (Obrigat√≥rio se tiver arquivo)
            // Se n√£o tiver arquivo, podemos enviar FormData mesmo assim, o multer ignora o campo vazio
            const formData = new FormData();

            formData.append('veiculo_id', veiculo);
            formData.append('numero_apolice', document.getElementById('numero_apolice').value);
            formData.append('numero_proposta', document.getElementById('numero_proposta').value);
            formData.append('vigencia_inicio', document.getElementById('vigencia_inicio').value);
            formData.append('vigencia_fim', document.getElementById('vigencia_fim').value);
            
            // Converte de volta para americano para salvar
            formData.append('premio_liquido', getValorMoeda('premio_liquido'));
            formData.append('premio_total', getValorMoeda('premio_total'));
            formData.append('franquia_casco', getValorMoeda('franquia_casco'));

            // Anexa arquivo se existir
            if (temArquivo) {
                formData.append('arquivo_pdf', fileInput.files[0]);
            }

            // Headers (IMPORTANTE: N√£o setar Content-Type para FormData, o browser faz isso)
            const headers = { 'Authorization': `Bearer ${localToken}` };

            // Se for EDI√á√ÉO e N√ÉO tiver arquivo novo, seria melhor mandar JSON, mas vamos padronizar FormData
            // O backend est√° preparado para uploadSave.single(), se n√£o vier arquivo, ele segue.
            
            try {
                Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });
                
                // Se for PUT e quisermos mandar JSON (caso seu backend tenha rotas distintas para update sem arquivo)
                // Mas seu backend suporta update com arquivo?
                // Vamos tentar FormData. Se seu backend no PUT n√£o usa 'uploadSave', isso pode falhar.
                // VERIFICA√á√ÉO: Seu server.js no PUT n√£o tem 'uploadSave'. Ent√£o:
                
                let res;
                if (method === 'POST') {
                    // POST (Criar): Usa FormData (Backend espera uploadSave)
                    res = await fetch(endpoint, { method, headers, body: formData });
                } else {
                    // PUT (Editar): Seu backend atual N√ÉO tem upload no PUT.
                    // Ent√£o mandamos JSON e ignoramos o arquivo por enquanto no update (limita√ß√£o atual do backend)
                    // Se voc√™ quiser update de arquivo, precisa mudar o server.js.
                    // Por enquanto, salvamos os dados:
                    const jsonBody = {};
                    formData.forEach((value, key) => jsonBody[key] = value);
                    
                    headers['Content-Type'] = 'application/json';
                    res = await fetch(endpoint, { method, headers, body: JSON.stringify(jsonBody) });
                }
                
                if (res.ok) {
                    await Swal.fire('Sucesso!', 'Ap√≥lice salva com sucesso.', 'success');
                    window.location.href = 'dashboard.html';
                } else {
                    const err = await res.json();
                    Swal.fire('Erro', err.message || 'Erro ao salvar.', 'error');
                }
            } catch (err) { 
                console.error(err);
                Swal.fire('Erro', 'Falha na conex√£o.', 'error'); 
            }
        }

        async function executarSalvamento(e) { return ejecutarSalvamento(e); }

        async function carregarVeiculos() {
            try {
                const res = await fetch(`${BASE_URL}/propostas`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const lista = await res.json();
                const sel = document.getElementById('veiculo_id');
                sel.innerHTML = '<option value="">-- Selecione --</option>';
                lista.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = `${p.nome} | ${p.placa}`;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function prepararModoEdicao() {
            try {
                document.getElementById('titulo-pagina').innerText = `Editando Ap√≥lice #${idEdicao}`;
                document.getElementById('btn-acao-salvar').innerHTML = 'ATUALIZAR DADOS';
                // Mostra upload para permitir substitui√ß√£o
                const area = document.querySelector('.upload-container');
                if(area) area.style.display = 'flex'; 

                const res = await fetch(`${BASE_URL}/apolices/${idEdicao}`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const d = await res.json();

                setValorTexto('veiculo_id', d.veiculo_id);
                setValorTexto('numero_apolice', d.numero_apolice);
                setValorTexto('numero_proposta', d.numero_proposta);
                
                setValorMoeda('premio_liquido', d.premio_liquido);
                setValorMoeda('premio_total', d.premio_total);
                setValorMoeda('franquia_casco', d.franquia_casco);
                
                if (d.vigencia_inicio) setValorTexto('vigencia_inicio', d.vigencia_inicio.split('T')[0]);
                if (d.vigencia_fim) setValorTexto('vigencia_fim', d.vigencia_fim.split('T')[0]);
            } catch (e) { console.error(e); }
        }
    })();
    </script>
</body>
</html>