<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emissão de Apólice</title>
    
    <script src="js/config.js"></script>

    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' blob: data: gap:; style-src * 'self' 'unsafe-inline' blob: data: gap:; script-src * 'self' 'unsafe-eval' 'unsafe-inline' blob: data: gap:; connect-src * 'unsafe-inline' blob: data: gap:;">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        .loading { color: #666; font-style: italic; }
        .btn-processar { background-color: #2e7d32; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-processar:hover { background-color: #1b5e20; }
        .btn-salvar { width: 100%; margin-top: 20px; padding: 15px; background-color: #1976d2; color: white; font-weight: bold; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        .btn-salvar:hover { background-color: #1565c0; }
        
        .upload-container {
            background-color: #e3f2fd;
            border: 2px dashed #1976d2;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        #status-pdf { font-weight: bold; margin-top: 10px; min-height: 20px; }
    </style>
</head>
<body class="dashboard-body">

    <header class="app-header">
        <div class="header-brand"><a href="dashboard.html"><img src="assets/logo.png" alt="Logo" class="header-logo"></a></div>
        <nav class="header-nav">
            <a href="dashboard.html" class="header-link">DASHBOARD</a>
            <a href="apolice.html" class="header-link active">APÓLICES</a>
            <a href="registro.html?origin=dashboard" class="header-link">USUÁRIOS</a>
            <a href="relatorios.html" class="header-link">RELATÓRIOS</a>
        </nav>
        <div class="header-user-area">
            <div class="user-info"><span class="user-name">Olá, <strong id="user-name-display">...</strong></span></div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        <div style="margin-bottom: 20px; border-left: 5px solid #2e7d32; padding-left: 15px;">
            <h2 style="color: #444; margin:0;">Emissão de Apólice</h2>
            <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Importe o PDF e salve os dados.</p>
        </div>

        <div class="upload-container">
            <p style="font-size:15px; color:#333; margin-bottom:10px;"><b>Passo 1:</b> Selecione o PDF da apólice</p>
            <input type="file" id="pdf_upload" name="arquivo_pdf" accept="application/pdf" style="margin-bottom: 10px;">
            <br>
            <button type="button" id="btn-ler-pdf" class="btn-processar">
                <i class="fas fa-magic"></i> Ler Dados do PDF
            </button>
            <p id="status-pdf"></p>
        </div>

        <div class="card" id="painel-apolice" style="margin-top: 20px;">
            <h3 style="margin:0 0 20px 0; color:#2e7d32; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                Passo 2: Conferir Dados
            </h3>
            
            <label style="font-weight:bold;">Veículo / Cliente *</label>
            <select id="veiculo_id" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; background: #fff;">
                <option value="">Carregando...</option>
            </select>

            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <label>Nº Apólice</label>
                    <input type="text" id="numero_apolice" class="campo-dado" style="width: 100%; padding: 10px;">
                </div>
                <div style="flex: 1;">
                    <label>Nº Proposta</label>
                    <input type="text" id="numero_proposta" class="campo-dado" style="width: 100%; padding: 10px;">
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label>Início Vigência</label>
                    <input type="date" id="vigencia_inicio" class="campo-dado" style="width: 100%; padding: 10px;">
                </div>
                <div style="flex: 1;">
                    <label>Fim Vigência</label>
                    <input type="date" id="vigencia_fim" class="campo-dado" style="width: 100%; padding: 10px;">
                </div>
            </div>

            <h4 style="margin: 0 0 10px 0; color: #555;">Valores Financeiros (Use ponto 1000.00)</h4>
            <div style="display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label>Prêmio Líquido</label>
                    <input type="text" id="premio_liquido" style="width: 100%; padding: 10px;">
                </div>
                <div style="flex: 1;">
                    <label style="color: #2e7d32; font-weight: bold;">Prêmio Total</label>
                    <input type="text" id="premio_total" style="width: 100%; padding: 10px; background-color: #e8f5e9; font-weight: bold; border: 1px solid #2e7d32;">
                </div>
                <div style="flex: 1;">
                    <label>Franquia</label>
                    <input type="text" id="franquia_casco" style="width: 100%; padding: 10px;">
                </div>
            </div>

            <button type="button" id="btn-acao-salvar" class="btn-salvar">
                <i class="fas fa-save"></i> SALVAR APÓLICE
            </button>
        </div>
        
        <div style="text-align:center; margin-top:20px; color:#999; font-size:12px;">ASL TECH SYSTEM</div>
    </div>

    <script>
    (function() {
        const BASE_URL = (typeof API_URL !== 'undefined') ? API_URL : 'http://localhost:3000';
        const localToken = localStorage.getItem('token');
        const urlParams = new URLSearchParams(window.location.search);
        const idEdicao = urlParams.get('id');

        if (!localToken) { window.location.href = 'index.html'; return; }

        function setValor(id, valor) {
            const el = document.getElementById(id);
            if(el && valor !== undefined && valor !== null) {
                el.value = valor;
            }
        }

        // LER PDF
        document.getElementById('btn-ler-pdf').addEventListener('click', async (e) => {
            e.preventDefault(); 
            const fileInput = document.getElementById('pdf_upload');
            const statusMsg = document.getElementById('status-pdf');

            if (fileInput.files.length === 0) return Swal.fire('Atenção', 'Selecione o arquivo PDF primeiro.', 'warning');

            statusMsg.innerText = "Processando...";
            
            const fd = new FormData();
            fd.append('arquivoPdf', fileInput.files[0]);

            try {
                const res = await fetch(`${BASE_URL}/importar-pdf`, { 
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${localToken}` },
                    body: fd 
                });
                const json = await res.json();
                const d = json.dados;
                
                console.log("DADOS DO PDF:", d);

                setValor('numero_apolice', d.numero_apolice);
                setValor('numero_proposta', d.numero_proposta);
                setValor('vigencia_inicio', d.vigencia_inicio);
                setValor('vigencia_fim', d.vigencia_fim);
                
                // MANTÉM O VALOR COMO VEIO (STRING) PARA NÃO ZERAR
                setValor('premio_total', d.premio_total);
                setValor('premio_liquido', d.premio_liquido);
                setValor('franquia_casco', d.franquia_casco);

                statusMsg.innerText = "Lido com sucesso!";
                statusMsg.style.color = "green";

                if (d.placa) {
                    const sel = document.getElementById('veiculo_id');
                    const busca = d.placa.toUpperCase().replace(/[^A-Z0-9]/g, '');
                    for(let i=0; i<sel.options.length; i++) {
                        if(sel.options[i].text.replace(/[^A-Z0-9]/g, '').includes(busca)) {
                            sel.selectedIndex = i;
                            break;
                        }
                    }
                }
            } catch(err) {
                console.error(err);
                statusMsg.innerText = "Erro ao ler.";
                Swal.fire('Erro', 'Falha na leitura do PDF.', 'error');
            }
        });

        // SALVAR APÓLICE
        document.getElementById('btn-acao-salvar').addEventListener('click', async (e) => {
            e.preventDefault();
            
            const veiculo = document.getElementById('veiculo_id').value;
            if (!veiculo) return Swal.fire('Erro', 'Selecione o Cliente/Veículo!', 'error');

            const fileInput = document.getElementById('pdf_upload');
            
            if (!idEdicao && fileInput.files.length === 0) {
                return Swal.fire('Atenção', 'O arquivo PDF não foi detectado. Selecione novamente.', 'warning');
            }

            const formData = new FormData();
            formData.append('veiculo_id', veiculo);
            formData.append('numero_apolice', document.getElementById('numero_apolice').value || '');
            formData.append('numero_proposta', document.getElementById('numero_proposta').value || '');
            formData.append('vigencia_inicio', document.getElementById('vigencia_inicio').value || '');
            formData.append('vigencia_fim', document.getElementById('vigencia_fim').value || '');
            
            // PEGA O VALOR DO INPUT DIRETAMENTE
            formData.append('premio_liquido', document.getElementById('premio_liquido').value);
            formData.append('premio_total', document.getElementById('premio_total').value);
            formData.append('franquia_casco', document.getElementById('franquia_casco').value);

            if (fileInput.files.length > 0) {
                formData.append('arquivo_pdf', fileInput.files[0]);
            }

            const endpoint = idEdicao ? `${BASE_URL}/apolices/${idEdicao}` : `${BASE_URL}/cadastrar-apolice`;
            const method = idEdicao ? 'PUT' : 'POST';

            try {
                Swal.fire({ title: 'Salvando...', didOpen: () => Swal.showLoading() });

                const res = await fetch(endpoint, { 
                    method: method, 
                    headers: { 'Authorization': `Bearer ${localToken}` },
                    body: formData 
                });
                
                const json = await res.json();

                if (res.ok) {
                    await Swal.fire('Sucesso!', 'Apólice e Arquivo salvos!', 'success');
                    window.location.href = 'dashboard.html';
                } else {
                    Swal.fire('Erro', json.message || 'Erro ao salvar.', 'error');
                }
            } catch(err) {
                console.error(err);
                Swal.fire('Erro', 'Falha de conexão com o servidor.', 'error');
            }
        });

        // CARREGAR DADOS
        (async () => {
            try {
                const res = await fetch(`${BASE_URL}/propostas`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const list = await res.json();
                const sel = document.getElementById('veiculo_id');
                list.forEach(i => {
                    sel.innerHTML += `<option value="${i.id}">${i.nome} | ${i.placa}</option>`;
                });
            } catch(e) {}

            if(idEdicao) {
                document.getElementById('btn-acao-salvar').innerText = "ATUALIZAR DADOS";
                try {
                    const res = await fetch(`${BASE_URL}/apolices/${idEdicao}`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                    const d = await res.json();
                    setValor('veiculo_id', d.veiculo_id);
                    setValor('numero_apolice', d.numero_apolice);
                    setValor('numero_proposta', d.numero_proposta);
                    setValor('premio_total', d.premio_total);
                    setValor('premio_liquido', d.premio_liquido);
                    setValor('franquia_casco', d.franquia_casco);
                    if(d.vigencia_inicio) setValor('vigencia_inicio', d.vigencia_inicio.split('T')[0]);
                    if(d.vigencia_fim) setValor('vigencia_fim', d.vigencia_fim.split('T')[0]);
                } catch(e) {}
            }
        })();

        document.getElementById('btn-logout').addEventListener('click', () => { 
            localStorage.clear(); window.location.href = 'index.html'; 
        });
    })();
    </script>
</body>
</html>