<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta http-equiv="Content-Security-Policy" 
    content="default-src * 'self' blob: data: gap:; 
    style-src * 'self' 'unsafe-inline' blob: data: gap:; 
    script-src * 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net blob: data: gap:; 
    object-src * 'self' blob: data: gap:; 
    img-src * 'self' 'unsafe-inline' blob: data: gap:; 
    connect-src 'self' http://localhost:3000 https://seguradoraproject.onrender.com * 'unsafe-inline' blob: data: gap:; 
    font-src 'self' data: https://cdnjs.cloudflare.com; 
    frame-src * 'self' blob: data: gap:;">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <title>Gestor Clientes e Ap√≥lices - Painel</title>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .stats-container { display: flex; justify-content: space-between; gap: 25px; flex-wrap: wrap; padding-right: 5px; }
        .stat-card { flex: 1; min-width: 220px; margin-bottom: 0; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .badge-admin { background-color: #7b1fa2; color: white; }
        .badge-user { background-color: #1976d2; color: white; }
    </style>
</head>
<body class="dashboard-body">
    
    <header class="app-header">
        <div class="header-brand">
            <a href="dashboard.html"><img src="assets/logo.png" alt="Logo" class="header-logo"></a>
        </div>
        <nav class="header-nav">
            <a href="dashboard.html" class="header-link active">DASHBOARD</a>
            <a href="apolice.html" class="header-link">AP√ìLICES</a>
            <a href="registro.html?origin=dashboard" class="header-link">USU√ÅRIOS</a>
            <a href="relatorios.html" class="header-link">RELAT√ìRIOS</a>
        </nav>
        <div class="header-user-area">
            <div class="user-info">
                <span class="user-name">Ol√°, <strong id="user-name-display">...</strong></span>
                <span class="user-role" id="user-role-display">...</span>
            </div>
            <button id="btn-logout" class="btn-logout-panel">SAIR</button>
        </div>
    </header>

    <div class="main-container">
        
        <div class="stats-container" style="margin-bottom: 30px;">
            <div class="stat-card green">
                <div class="stat-info"><h3 id="total-clientes">...</h3><p>Clientes Ativos</p></div>
                <div class="stat-icon"><i class="fas fa-users"></i></div>
            </div>
            <div class="stat-card blue">
                <div class="stat-info"><h3 id="total-veiculos">...</h3><p>Ve√≠culos Cadastrados</p></div>
                <div class="stat-icon"><i class="fas fa-car"></i></div>
            </div>
            <div class="stat-card orange">
                <div class="stat-info"><h3 id="total-apolices">...</h3><p>Ap√≥lices Emitidas</p></div>
                <div class="stat-icon"><i class="fas fa-file-contract"></i></div>
            </div>
            <div class="stat-card purple">
                <div class="stat-info"><h3 id="total-usuarios">...</h3><p>Usu√°rios do Sistema</p></div>
                <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
            </div>
        </div>

        <div class="card">
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #444; border-left: 5px solid #ff9800; padding-left: 10px; margin: 0;">Gest√£o de Ap√≥lices</h3>
                    <a href="apolice.html" class="btn-novo" style="background-color: #ff9800; width: auto; padding: 10px 20px;">+ Nova Ap√≥lice</a>
                </div>
                <div style="overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 8px;">
                    <table class="tabela-crud">
                        <thead>
                            <tr>
                                <th>N¬∫ Ap√≥lice</th>
                                <th>Cliente / Ve√≠culo</th>
                                <th>Vig√™ncia Fim</th>
                                <th>Pr√™mio Total</th>
                                <th style="text-align:center">A√ß√µes</th> 
                            </tr>
                        </thead>
                        <tbody id="lista-apolices">
                            <tr><td colspan="5" style="text-align:center; padding: 20px;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #444; border-left: 5px solid #00a86b; padding-left: 10px; margin: 0;">Gest√£o de Clientes</h3>
                <a href="cadastro.html" class="btn-novo" style="background-color: #00a86b; width: auto; padding: 10px 20px;">+ Nova Proposta</a>
            </div>
            <div style="overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 8px;">
                <table class="tabela-crud">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>CPF/CNPJ</th>
                            <th>Placa</th>
                            <th>Modelo</th>
                            <th style="text-align:center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="lista-clientes">
                        <tr><td colspan="5" style="text-align:center; padding: 20px;">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" id="secao-usuarios">
            <div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #444; border-left: 5px solid #7b1fa2; padding-left: 10px; margin: 0;">Gest√£o de Usu√°rios </h3>
                    <a href="registro.html?origin=dashboard" class="btn-novo" style="background-color: #7b1fa2; width: auto; padding: 10px 20px;">+ Novo Usu√°rio</a>
                </div>
                <div style="overflow-x: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-radius: 8px;">
                    <table class="tabela-crud">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Perfil</th>
                                <th style="text-align: center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-usuarios">
                            <tr><td colspan="4" style="text-align:center; padding: 20px;">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="system-credits" style="text-align: center;">By √Åidano Lima - ASL TECH</div>
    </div> 
    
   <script>
    (function() {
        // Configura√ß√µes
        const LOCAL_API_URL = 'http://localhost:3000';
        const localToken = localStorage.getItem('token');

        console.log("üöÄ Dashboard Enterprise Iniciado");

        document.addEventListener('DOMContentLoaded', () => {
            if (!localToken) { window.location.href = 'index.html'; return; }

            const nome = localStorage.getItem('usuario_logado');
            const tipo = localStorage.getItem('tipo_usuario');
            if (document.getElementById('user-name-display') && nome) 
                document.getElementById('user-name-display').innerText = nome.split(' ')[0];
            if (document.getElementById('user-role-display') && tipo) 
                document.getElementById('user-role-display').innerText = tipo.toUpperCase();

            document.getElementById('btn-logout')?.addEventListener('click', () => { 
                localStorage.clear(); window.location.href = 'index.html'; 
            });

            // CARREGAR TUDO
            carregarResumo();
            carregarTabelaApolices();
            carregarTabelaClientes(); 
            carregarTabelaUsuarios();
        });
<<<<<<< HEAD

        // --- CARDS ---
        async function carregarResumo() {
            try {
                const res = await fetch(`${LOCAL_API_URL}/dashboard-resumo`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const d = await res.json();
                document.getElementById('total-clientes').innerText = d.clientes || '0';
                document.getElementById('total-veiculos').innerText = d.veiculos || '0';
                document.getElementById('total-apolices').innerText = d.apolices || '0';
                document.getElementById('total-usuarios').innerText = d.usuarios || '0';
            } catch (e) { console.error("Erro resumo:", e); }
        }

        // --- AP√ìLICES ---
        async function carregarTabelaApolices() {
            const tbody = document.getElementById('lista-apolices');
            if(!tbody) return;
            try {
                const res = await fetch(`${LOCAL_API_URL}/apolices`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const lista = await res.json();
                tbody.innerHTML = '';

                if (lista.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Nenhuma ap√≥lice encontrada.</td></tr>';
                    return;
                }

                lista.forEach(item => {
                    const dataFim = item.vigencia_fim ? new Date(item.vigencia_fim).toLocaleDateString('pt-BR') : '-';
                    const valor = item.premio_total ? parseFloat(item.premio_total).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
                    const clienteInfo = item.cliente ? `<strong>${item.cliente}</strong><br><small style="color:#666">${item.placa || ''}</small>` : `<span style="color:#999">Sem v√≠nculo</span>`;
                    
                    const urlPdf = item.arquivo_pdf ? `${LOCAL_API_URL}/uploads/${item.arquivo_pdf}` : null;
                    const botaoPdfHtml = urlPdf
                        ? `<a href="${urlPdf}" target="_blank" class="action-btn" title="Ver PDF" style="background-color:#757575; padding:5px 8px; border-radius:4px; color:white; margin-right:5px;"><i class="fas fa-file-pdf"></i></a>`
                        : `<span style="color:#ccc; margin-right:5px;"><i class="fas fa-file-pdf"></i></span>`;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold; color:#003366;">${item.numero_apolice || 'S/N'}</td>
                        <td>${clienteInfo}</td>
                        <td>At√© ${dataFim}</td>
                        <td style="color:#00a86b; font-weight:bold;">${valor}</td>
                        <td style="text-align:center">
                            ${botaoPdfHtml}
                            <a href="apolice.html?id=${item.id}" class="action-btn" style="background-color:#1976d2; padding:5px 8px; border-radius:4px; color:white; margin-right:5px;"><i class="fas fa-edit"></i></a>
                            <button onclick="excluirItem('apolices', ${item.id})" class="action-btn" style="background-color:#d32f2f; padding:5px 8px; border-radius:4px; color:white; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Erro ao carregar dados.</td></tr>'; }
        }

        // --- CLIENTES (AGORA LINKA PARA CADASTRO.HTML) ---
        async function carregarTabelaClientes() {
            const tbody = document.getElementById('lista-clientes');
            if(!tbody) return;
            try {
                const res = await fetch(`${LOCAL_API_URL}/propostas`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const lista = await res.json();
                tbody.innerHTML = '';

                if (lista.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Nenhum cliente encontrado.</td></tr>';
                    return;
                }

                lista.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold;">${item.nome ? item.nome.toUpperCase() : 'SEM NOME'}</td>
                        <td>${item.documento || '-'}</td>
                        <td><span style="background:#eee; padding:2px 6px; border-radius:4px; font-weight:bold;">${item.placa || 'S/PLACA'}</span></td>
                        <td>${item.modelo_veiculo || '-'}</td>
                        <td style="text-align:center">
                            <a href="cadastro.html?id=${item.id}" class="action-btn" style="background-color:#1976d2; color:white; padding:5px 8px; border-radius:4px; margin-right:5px;"><i class="fas fa-edit"></i></a>
                            <button onclick="excluirItem('propostas', ${item.id})" class="action-btn" style="background-color:#d32f2f; padding:5px 8px; border-radius:4px; color:white; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Erro ao carregar clientes.</td></tr>'; }
        }

        // --- USU√ÅRIOS ---
        async function carregarTabelaUsuarios() {
            const tbody = document.getElementById('lista-usuarios');
            if(!tbody) return;
            try {
                const res = await fetch(`${LOCAL_API_URL}/usuarios`, { headers: { 'Authorization': `Bearer ${localToken}` } });
                const lista = await res.json();
                tbody.innerHTML = '';

                lista.forEach(item => {
                    const badgeClass = item.tipo === 'admin' ? 'badge-admin' : 'badge-user';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold;">${item.nome}</td>
                        <td>${item.email}</td>
                        <td><span class="badge ${badgeClass}">${item.tipo.toUpperCase()}</span></td>
                        <td style="text-align:center">
                            <a href="registro.html?id=${item.id}" class="action-btn" style="background-color:#1976d2; color:white; padding:5px 8px; border-radius:4px; margin-right:5px;"><i class="fas fa-edit"></i></a>
                            <button onclick="excluirItem('usuarios', ${item.id})" class="action-btn" style="background-color:#d32f2f; padding:5px 8px; border-radius:4px; color:white; border:none; cursor:pointer;"><i class="fas fa-trash"></i></button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            } catch (error) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Erro ao carregar usu√°rios.</td></tr>'; }
        }

        // --- EXCLUS√ÉO GEN√âRICA ---
        window.excluirItem = async function(rota, id) {
            const confirm = await Swal.fire({
                title: 'Tem certeza?',
                text: "Essa a√ß√£o √© irrevers√≠vel.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Sim, excluir!'
            });

            if (confirm.isConfirmed) {
                try {
                    const res = await fetch(`${LOCAL_API_URL}/${rota}/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localToken}` }
                    });
                    if (res.ok) {
                        Swal.fire('Exclu√≠do!', 'Registro removido.', 'success');
                        carregarResumo();
                        carregarTabelaApolices();
                        carregarTabelaClientes();
                        carregarTabelaUsuarios();
                    } else { Swal.fire('Erro', 'N√£o foi poss√≠vel excluir.', 'error'); }
                } catch (e) { Swal.fire('Erro', 'Falha na conex√£o.', 'error'); }
            }
        };
    })();
</script>
</body>
=======
    </script>

    <script src="js/config.js"></script>  
    <script src="js/dashboard.js"></script>

</body>
</html>
    
    </body>
>>>>>>> d1c4750d0ed02d4e6a9157eb82c6bced24dffb07
</html>